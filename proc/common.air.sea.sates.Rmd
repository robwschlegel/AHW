---
title: "Common Air-Sea States"
output: html_notebook
---

# Rationale
In order to better understand the results of either hierarchical clustering or SOMs on the air-sea states during MHWs, it is necessary to also create cluster analyses on the 'normal' air-sea states as well. There are many possible ways of doing this however, the datasets (BRAN particularly) are massive so some method of dimension reduction is required. The daily climatologies for all temperature, u and v pixels for both BRAN and ERA have already been calculated so this is used in lieue of running a cluster analysis on every day of air-sea data available across both datasets. Additionally, the same methodology is applied to anomaly data generated by subtracting the overall mean air-sea state from the daily climatologies.

```{r, echo=FALSE, message=FALSE}
library(plyr)
library(dplyr)
library(reshape2)
library(data.table)
library(ggplot2)
```

# Methods
## Loading
The first step is to load these rather large data frames into virtual memmory and combine them into one long massive data frame.

```{r}
# # BRAN
# load("~/AHW/data/BRAN/BRAN_temp_daily.Rdata")
# load("~/AHW/data/BRAN/BRAN_u_daily.Rdata")
# load("~/AHW/data/BRAN/BRAN_v_daily.Rdata")
# # ERA
# load("~/AHW/data/ERA/ERA_all_daily.Rdata")
# 
# # Create common column naming convention
# colnames(BRAN_temp_daily)[4] <- "value"
# BRAN_temp_daily$variable <- "BRAN/temp"
# colnames(BRAN_u_daily)[4] <- "value"
# BRAN_u_daily$variable <- "BRAN/u"
# colnames(BRAN_v_daily)[4] <- "value"
# BRAN_v_daily$variable <- "BRAN/v"
# ERA_all_daily <- melt(ERA_all_daily, id.vars = c("x","y","date"))
# ERA_all_daily$variable <- paste0("ERA/",ERA_all_daily$variable)
# 
# # Combine
# all_daily <- rbind(BRAN_temp_daily, BRAN_u_daily, BRAN_v_daily, ERA_all_daily)
# all_daily$x <- round(all_daily$x,2) # Have to use second decimal place as first decimal rounding creates possible duplicate entries
# all_daily$y <- round(all_daily$y,2)
# all_daily$index <- paste0(all_daily$x,"_",all_daily$y,"_",all_daily$variable)
# save(all_daily, file = "~/AHW/data/all_daily.Rdata")
# 
# # Free up some virtual memmory
# rm(list = c("BRAN_temp_daily", "BRAN_u_daily", "BRAN_v_daily", "ERA_all_daily"))

# The above code is time and RAM heavy and must only be run once
# Therefore the output has been saved and is simply loaded here
load("~/AHW/data/all_daily.Rdata")
```

## Pixel Reduction
Before the data are transposed, it is necessary to reduce the resolution in the BRAN data so that the sea variables are not over-represented against the ERA data. Additional pixel reduction is also performed here in order to investigate the effects pixel resolution may be having on the clustering model capabilities.

```{r}
# 0.5 degree resolution
all_0.5 <- all_daily %>% 
  mutate(x = round_any(x, 0.5)) %>% 
  mutate(y = round_any(y, 0.5))
all_0.5 <- data.table(all_0.5)
all_0.5 <- all_0.5[, .(value = mean(value, na.rm = TRUE)),
                                   by = .(x, y, variable, date)]
all_0.5$index <- paste0(all_0.5$x,"_",all_0.5$y,"_",all_0.5$variable)

# 1.0 degree resolution
all_1.0 <- all_0.5 %>% 
  mutate(x = round_any(x, 1.0)) %>% 
  mutate(y = round_any(y, 1.0))
all_1.0 <- data.table(all_1.0)
all_1.0 <- all_1.0[, .(value = mean(value, na.rm = TRUE)),
                                   by = .(x, y, variable, date)]
all_1.0$index <- paste0(all_1.0$x,"_",all_1.0$y,"_",all_1.0$variable)

# 2.0 degree resolution... for interests sake
all_2.0 <- all_1.0 %>% 
  mutate(x = round_any(x, 2.0)) %>% 
  mutate(y = round_any(y, 2.0))
all_2.0 <- data.table(all_2.0)
all_2.0 <- all_2.0[, .(value = mean(value, na.rm = TRUE)),
                                   by = .(x, y, variable, date)]
all_2.0$index <- paste0(all_2.0$x,"_",all_2.0$y,"_",all_2.0$variable)
```


## Transposing
Once that is done it is necessary to transpose the data so that each daily air-sea climatology can be given to hierarchical clustering in order to be grouped.

```{r}
# Cast by day to create wide data frames with 366 rows
all_daily_wide <- dcast(all_daily, date~index, value.var = "value")
rownames(all_daily_wide) <- all_daily_wide$date
all_daily_wide$date <- NULL

all_0.5_wide <- dcast(all_0.5, date~index, value.var = "value")
rownames(all_0.5_wide) <- all_0.5_wide$date
all_0.5_wide$date <- NULL

all_1.0_wide <- dcast(all_1.0, date~index, value.var = "value")
rownames(all_1.0_wide) <- all_1.0_wide$date
all_1.0_wide$date <- NULL

all_2.0_wide <- dcast(all_2.0, date~index, value.var = "value")
rownames(all_2.0_wide) <- all_2.0_wide$date
all_2.0_wide$date <- NULL
```

## Clustering
After transposing the data they may now be clustered via any number of methods. Here we use heierarchical clustering as it is the most straightforward.

```{r}
# A function for running standardization and euclidean distance at once
all.vegdist <- function(df){
  deco <- decostand(df, method = "standardize") # Standardize all values for similarity
  dis <- vegdist(coast.deco, method = "euclidean") # Distance matrix for ordinations
  return(dis)
}
```

